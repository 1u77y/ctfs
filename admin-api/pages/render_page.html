
<!-- Hidden CTF hint: only visible in DevTools -->
<!--
/**
 * Submit a template to the backend rendering API.
 * 
 * Endpoint: POST /render/json
 * Content-Type: application/json
 *
 * Request body parameters:
 * @param {string} template - The template source code to render (required).
 * @param {string} [image_url] - Optional URL of the image to use in the template.
 *
 * Response:
 * @returns {object} 200 - JSON object containing the rendered HTML
 *   - {string} rendered_html - The HTML output of the rendered template
 * @returns {object} 400 - JSON object containing an error message for template errors
 * @returns {object} 413 - JSON object containing an error message if template is too large
 *
 *
 */


-->










































<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Template Preview — Gallery</title>

<style>
    body { background: #0a0a0a; color: #d0d0d0; font-family: Consolas, monospace; padding: 40px; }
    h1 { color: #fff; border-bottom: 1px solid #333; padding-bottom: 6px; margin-bottom: 25px; }
    .panel { background: #111; border: 1px solid #333; padding: 18px; border-radius: 6px; margin-bottom: 20px; }
    textarea { width: 100%; height: 260px; font-family: Consolas, monospace; background: #0e0e0e; color: #eee; border: 1px solid #444; padding: 10px; border-radius: 6px; white-space: pre; }
    input[type="text"] { width: 100%; padding: 8px; background: #0e0e0e; color: #eee; border: 1px solid #444; border-radius: 6px; }
    button { background: #222; color: #eee; border: 1px solid #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #333; }
    select { background: #0e0e0e; color: #eee; border: 1px solid #555; padding: 4px; border-radius: 4px; }
    .hintbox { background: #121212; border-left: 4px solid #ffd966; padding: 12px; margin-bottom: 20px; }
    .blink { animation: blink 1.2s infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
    hr { border: none; border-top: 1px solid #333; margin: 25px 0; }
    small { color: #555; }
    #preview { margin-top: 20px; background: #111; padding: 16px; border-radius: 6px; border: 1px solid #333; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>Admin Template Preview — Gallery</h1>

<div class="panel">
    <strong>Context</strong>
    <p>This subsystem renders caption templates for images. Operators test templates here before publishing them.</p>
    <div class="hintbox">
        <strong>Operator Notice:</strong><br>
        Some templates behave differently depending on context.<br>
        Some operators noticed things others didn’t.<br>
        <span class="blink">Some say the preview hides more than it shows.</span>
    </div>
</div>

<div class="panel">
    <strong>Available variables</strong>
    <ul>
        <li><code>username</code> — admin username</li>
        <li><code>image_url</code> — URL of the image</li>
        <li><code>server_time</code> — UTC</li>
        <li><code>notice</code> — operator message</li>
    </ul>
    <p>Use the examples or craft your own template. Submissions are logged.</p>
</div>

<div style="margin-bottom:12px;">
    <label for="example_select"><strong>Example templates:</strong></label>
    <select id="example_select">
        <option value="">-- choose example --</option>
    </select>
    <button id="load_example" type="button">Load</button>
    <button id="refresh_list" type="button">Refresh list</button>
</div>

<form id="render_form">
    <label for="template"><strong>Template source</strong></label><br>
    <textarea id="template" name="template" placeholder="Type template here..."></textarea><br><br>

    <label for="image_url"><strong>Image URL (optional)</strong></label><br>
    <input id="image_url" type="text" name="image_url" value=""><br><br>

    <button type="submit">Render preview</button>
</form>

<div id="preview"></div>

<hr>
<p><small>[ log: operator template submission accepted ]</small></p>

<script>
async function fetchList() {
    const encoded = encodeURIComponent('http://admin_api:9000/templates/list');
    const res = await fetch(`http://${window.location.hostname}:12000/fetch?url=${encoded}`);
    const data = await res.json();
    const sel = document.getElementById('example_select');
    sel.innerHTML = '<option value="">-- choose example --</option>';
    (data.templates || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
    });
}

async function loadExample() {
    const sel = document.getElementById('example_select');
    if (!sel.value) return;
    const name = encodeURIComponent(sel.value);
    const encoded = encodeURIComponent('http://admin_api:9000/templates/get?name='+name);
    const res = await fetch(`http://${window.location.hostname}:12000/fetch?url=${encoded}` );
    if (!res.ok) { alert('Could not load template'); return; }
    const txt = await res.text();
    document.getElementById('template').value = txt;
}

document.getElementById('load_example').addEventListener('click', loadExample);
document.getElementById('refresh_list').addEventListener('click', fetchList);
fetchList().catch(e => console.error(e));

// ---- AJAX form submission ----
document.getElementById('render_form').addEventListener('submit', async function(e) {
    e.preventDefault(); // Prevent normal form submission

    const template = document.getElementById('template').value;
    const image_url = document.getElementById('image_url').value;

    // Update browser URL without reloading
    const urlParam = encodeURIComponent(`http://${window.location.hostname}:9000/render`);
    history.replaceState(null, '', '/fetch?url=' + urlParam);

    try {
        const encoded = encodeURIComponent('http://admin_api:9000/render');
        const res = await fetch(`http://${window.location.hostname}:12000/fetch?url=${encoded}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ template, image_url })
        });

        if (!res.ok) {
            document.getElementById('preview').textContent = '[Error rendering template]';
            return;
        }

        const html = await res.text();
        document.getElementById('preview').innerHTML = html;
    } catch(err) {
        document.getElementById('preview').textContent = '[Request failed]';
        console.error(err);
    }
});
</script>

</body>
</html>
