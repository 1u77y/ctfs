# ===============================
# Nginx Production Configuration
# ===============================

worker_processes auto;

events { 
    worker_connections 1024; 
}

http {
    include       mime.types;

    # default JSON, HTML explicitly
    default_type  application/json;

    types {
        text/html  html;
    }

    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout 65;
    client_max_body_size 1m;

    limit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    log_format fetch_blocked '$remote_addr - [$time_local] '
                             '"$request" url="$arg_url" reason="$upstream_http_x_fetch_block_reason" '
                             'ua="$http_user_agent"';

    access_log  /var/log/nginx/access.log combined;
    access_log  /var/log/nginx/fetch_blocked.log fetch_blocked;

    # -----------------------------
    # Custom error pages
    # -----------------------------
    error_page 404 /not_found.html;
    error_page 502 /not_found.html;

    # -----------------------------
    # Upstream definition
    # -----------------------------
    upstream public_app_upstream {
        server public-app:8080;
        keepalive 16;
    }

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        # Custom 404 page
        location = /not_found.html {
            internal;
            types { text/html html; }
        }

        # ---------------------------------------------------
        # Main proxy â€” all requests to public-app
        # ---------------------------------------------------
        location / {
            proxy_pass http://public_app_upstream;

            proxy_intercept_errors on;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
        }

        # ---------------------------------------------------
        # Swagger/OpenAPI redirections
        # ---------------------------------------------------
        location ~ ^/swagger/(.*)$ {
            set $swagger_file $1;
            return 302 /fetch?url=http://localhost:9000/openapi/swagger/$swagger_file;
        }

        location = /swagger.json {
            return 302 /fetch?url=$scheme://$host/swagger.json;
        }

        location = /openapi.json {
            return 302 /fetch?url=$scheme://$host/openapi.json;
        }

        location = /redoc {
            return 302 /fetch?url=$scheme://$host/redoc;
        }

        # ---------------------------------------------------
        # /fetch: strict validation + forced 404 interception
        # ---------------------------------------------------
        location = /fetch {

            proxy_intercept_errors on;
            proxy_pass_request_headers off;

            # require url parameter
            if ($arg_url = "") { return 404; }

            # require URL-encoded form
            if ($arg_url !~ "%[0-9A-Fa-f]{2}") { return 404; }

            # disallow credentials in URL
            if ($arg_url ~ "@") { return 404; }

            # disallow numeric/hex IPs
            if ($arg_url ~ "(0x[0-9A-Fa-f]+|\\b\\d{7,}\\b)") { return 404; }

            # disallow dotted IP
            if ($arg_url ~* "^[^:]+://\\d{1,3}(?:\\.\\d{1,3}){3}(?::\\d+)?(?:/|$)") { return 404; }

            # disallow hex in general
            if ($arg_url ~ "0x") { return 404; }

            # proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Content-Type $http_content_type;

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;
            proxy_set_header Connection "";

            proxy_redirect off;

            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 15s;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;

            proxy_set_header X-Max-Body-Bytes "16384";

            proxy_pass http://public_app_upstream/fetch$is_args$args;
        }

    }
}
