worker_processes auto;

events { 
    worker_connections 1024; 
}

http {
    include       mime.types;

    default_type  application/json;

    sendfile         on;
    tcp_nopush       on;
    keepalive_timeout 65;
    client_max_body_size 1m;

    limit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    log_format fetch_blocked '$remote_addr - [$time_local] '
                             '"$request" url="$arg_url" reason="$upstream_http_x_fetch_block_reason" '
                             'ua="$http_user_agent"';

    access_log  /var/log/nginx/access.log combined;
    access_log  /var/log/nginx/fetch_blocked.log fetch_blocked;

    error_page 404 /not_found.html;
    error_page 502 /not_found.html;

    upstream public_app_upstream {
        server public-app:8080;
        keepalive 16;
    }

    upstream admin_api_upstream {
        server admin_api:9000;
        keepalive 16;
    }

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        location = /not_found.html {
            internal;
        }

        # ---------------- Main proxy for public-app ----------------
        location / {
            proxy_pass http://public_app_upstream;
            proxy_intercept_errors on;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
        }

        # ---------------- Swagger/OpenAPI redirects ----------------
        location ~ ^/swagger/(.*)$ {
            return 302 /fetch/openapi/swagger/$1;
        }

        location = /swagger.json {
            return 302 /fetch/openapi/swagger.json;
        }

        location = /openapi.json {
            return 302 http://$host:12000/fetch/openapi/openapi.json;
        }

        location = /redoc {
            return 302 /fetch/openapi/redoc;
        }

        # ---------------- Block sensitive fetch routes ----------------
        location ~ ^/fetch/(status|templates/list|templates/get|admin|render|render/json)(/.*)?$ {
            return 404;
        }

        # ---------------- Proxy OpenAPI requests correctly ----------------
        location /fetch/openapi/ {
            proxy_pass http://admin_api_upstream/openapi/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

            # Handle OPTIONS preflight
            if ($request_method = 'OPTIONS') {
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain';
                return 204;
            }
        }

        # ---------------- Proxy /fetch/swagger requests ----------------
        location ~ ^/fetch/swagger/(.*)$ {
            proxy_pass http://admin_api_upstream/openapi/swagger/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /fetch/feedback {
            return 302 /fetch?url=http%3A%2F%2F109.205.181.210%3A12000%2Ffeedback;
        }

        # ---------------- General fetch proxy for all other requests ----------------
        location /fetch/ {
            proxy_pass http://admin_api_upstream$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

            # Handle OPTIONS preflight
            if ($request_method = 'OPTIONS') {
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain';
                return 204;
            }

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 15s;
            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;
        }



        # ---------------- Legacy query-based fetch (optional) ----------------
        location = /fetch {
            proxy_pass http://public_app_upstream/fetch$is_args$args;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 15s;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;
        }
    }
}
