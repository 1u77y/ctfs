worker_processes auto;

events { 
    worker_connections 1024; 
}

http {
    include       mime.types;

    default_type  application/json;

    sendfile         on;
    tcp_nopush       on;
    keepalive_timeout 65;
    client_max_body_size 1m;

    limit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    log_format fetch_blocked '$remote_addr - [$time_local] '
                             '"$request" url="$arg_url" reason="$upstream_http_x_fetch_block_reason" '
                             'ua="$http_user_agent"';

    access_log  /var/log/nginx/access.log combined;
    access_log  /var/log/nginx/fetch_blocked.log fetch_blocked;

    error_page 404 /not_found.html;
    error_page 502 /not_found.html;

    upstream public_app_upstream {
        server public-app:8080;
        keepalive 16;
    }

    upstream admin_api_upstream {
        server admin_api:9000;
        keepalive 16;
    }

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        location = /not_found.html {
            internal;
        }

        # ---------------- Main proxy for public-app ----------------
        location / {
            proxy_pass http://public_app_upstream;
            proxy_intercept_errors on;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
        }

        # ---------------- Swagger/OpenAPI redirects ----------------
        location ~ ^/swagger/(.*)$ {
            return 302 /fetch/openapi/swagger/$1;
        }

        location = /swagger.json {
            return 302 /fetch/openapi/swagger.json;
        }

        location = /openapi.json {
            return 302 http://$host:12000/fetch/openapi/openapi.json;
        }

        location = /redoc {
            return 302 /fetch/openapi/redoc;
        }

        # ---------------- Block sensitive fetch routes ----------------
        location ~ ^/fetch/(status|templates/list|templates/get|admin|render|render/json)(/.*)?$ {
            return 404;
        }

        location = /fetch/feedback {
            proxy_pass http://public_app_upstream$is_args$args;

            # Pass original request headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            # Ensure POST works with JSON or form data
            proxy_set_header Content-Type $http_content_type;
            proxy_set_header Content-Length $http_content_length;

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            send_timeout 10s;
        }


        # ---------------- Proxy OpenAPI requests correctly ----------------
        location /fetch/openapi/ {
            proxy_pass http://admin_api_upstream/openapi/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

            # Handle OPTIONS preflight
            if ($request_method = 'OPTIONS') {
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain';
                return 204;
            }
        }

        # ---------------- Proxy /fetch/swagger requests ----------------
        location ~ ^/fetch/swagger/(.*)$ {
            proxy_pass http://admin_api_upstream/openapi/swagger/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        # ---------------- General fetch proxy for all other requests ----------------
        location /fetch/ {
            proxy_pass http://admin_api_upstream$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

            # Handle OPTIONS preflight
            if ($request_method = 'OPTIONS') {
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain';
                return 204;
            }

            # ✅ pass POST body correctly
            proxy_set_header Content-Length $content_length;
            proxy_set_header Content-Type $content_type;

            if ($arg_url = "") {
                add_header X-Fetch-Error "missing_url";
                return 404;
            }
            

            # require URL-encoded form (must contain at least one %XX)
            if ($arg_url !~ "%[0-9A-Fa-f]{2}") {
                add_header X-Fetch-Error "url_not_urlencoded";
                return 404;
            }

            # disallow credentials in URL
            if ($arg_url ~ "@") {
                add_header X-Fetch-Error "credentials_in_url";
                return 404;
            }

            # disallow numeric / hex IPs
            if ($arg_url ~ "(0x[0-9A-Fa-f]+|\\b\\d{7,}\\b)") {
                add_header X-Fetch-Error "numeric_ip_form";
                return 404;
            }

            if ($arg_url ~* "^[^:]+://\\d{1,3}(?:\\.\\d{1,3}){3}(?::\\d+)?(?:/|$)") {
                add_header X-Fetch-Error "direct_dotted_ip";
                return 404;
            }

            if ($arg_url ~ "0x" ) {
                add_header X-Fetch-Error "hex_in_url";
                return 404;
            }


            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 15s;
            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;
        }



        # ---------------- Legacy query-based fetch (optional) ----------------
        location = /fetch {
            if ($arg_url = "") {
                add_header X-Fetch-Error "missing_url";
                return 404;
            }
            

            # require URL-encoded form (must contain at least one %XX)
            if ($arg_url !~ "%[0-9A-Fa-f]{2}") {
                add_header X-Fetch-Error "url_not_urlencoded";
                return 404;
            }

            # disallow credentials in URL
            if ($arg_url ~ "@") {
                add_header X-Fetch-Error "credentials_in_url";
                return 404;
            }

            # disallow numeric / hex IPs
            if ($arg_url ~ "(0x[0-9A-Fa-f]+|\\b\\d{7,}\\b)") {
                add_header X-Fetch-Error "numeric_ip_form";
                return 404;
            }

            if ($arg_url ~* "^[^:]+://\\d{1,3}(?:\\.\\d{1,3}){3}(?::\\d+)?(?:/|$)") {
                add_header X-Fetch-Error "direct_dotted_ip";
                return 404;
            }

            if ($arg_url ~ "0x" ) {
                add_header X-Fetch-Error "hex_in_url";
                return 404;
            }
            
            proxy_pass http://public_app_upstream/fetch$is_args$args;

            # ✅ pass POST body correctly
            proxy_set_header Content-Length $content_length;
            proxy_set_header Content-Type $content_type;

            


            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 15s;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;
        }
    }
}
