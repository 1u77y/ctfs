worker_processes auto;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/json;

    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout 65;
    client_max_body_size 1m;

    limit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    log_format fetch_blocked '$remote_addr - [$time_local] '
                             '"$request" url="$arg_url" reason="$upstream_http_x_fetch_block_reason" '
                             'ua="$http_user_agent"';
    access_log  /var/log/nginx/access.log combined;
    access_log  /var/log/nginx/fetch_blocked.log fetch_blocked;

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        # ---------------------------
        # Default proxy to Flask
        # ---------------------------
        location / {
            proxy_pass http://public-app:8080;

            proxy_set_header Host "public-app";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;

            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
        }

        # Redirect all Swagger UI static files to /fetch
        location ~ ^/swagger/(.*)$ {
            # $1 captures everything after /swagger/
            set $swagger_file $1;
            return 302 /fetch?url=http://localhost:9000/openapi/swagger/$swagger_file;
        }

        # Optional: If you also have /flasgger_static/ files
        location ~ ^/flasgger_static/(.*)$ {
            set $file $1;
            return 302 /fetch?url=http://localhost:9000/flasgger_static/$file;
        }

        # Proxy JSON specs through /fetch
        location = /apispec_1.json {
            return 302 /fetch?url=$scheme://$host/apispec_1.json;
        }

        location = /swagger.json {
            return 302 /fetch?url=$scheme://$host/swagger.json;
        }

        location = /openapi.json {
            return 302 /fetch?url=$scheme://$host/openapi.json;
        }

        # Optional: proxy ReDoc if you use it
        location = /redoc {
            return 302 /fetch?url=$scheme://$host/redoc;
        }

        # ---------------------------
        # /fetch proxy - URL-encoded only
        # ---------------------------
        location = /fetch {

            # limit_req zone=reqs burst=40 nodelay;
            # limit_conn conn_limit 40;

            proxy_pass_request_headers off;

            # require url parameter
            if ($arg_url = "") {
                add_header X-Fetch-Error "missing_url";
                return 400 '{"error":"missing url"}';
            }
            

            # require URL-encoded form (must contain at least one %XX)
            if ($arg_url !~ "%[0-9A-Fa-f]{2}") {
                add_header X-Fetch-Error "url_not_urlencoded";
                return 403 '{"error":"fetch url must be URL-encoded"}';
            }

            # disallow credentials in URL
            if ($arg_url ~ "@") {
                add_header X-Fetch-Error "credentials_in_url";
                return 403 '{"error":"credentials-in-url not allowed"}';
            }

            # disallow numeric / hex IPs
            if ($arg_url ~ "(0x[0-9A-Fa-f]+|\\b\\d{7,}\\b)") {
                add_header X-Fetch-Error "numeric_ip_form";
                return 403 '{"error":"numeric/hex-ip forms not allowed"}';
            }

            if ($arg_url ~* "^[^:]+://\\d{1,3}(?:\\.\\d{1,3}){3}(?::\\d+)?(?:/|$)") {
                add_header X-Fetch-Error "direct_dotted_ip";
                return 403 '{"error":"direct-dotted-ip fetch forbidden"}';
            }

            if ($arg_url ~ "0x" ) {
                add_header X-Fetch-Error "hex_in_url";
                return 403 '{"error":"hex notation not allowed"}';
            }

            # proxy headers to Flask
            proxy_set_header Host "public-app";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Server;
            proxy_set_header Connection "";

            proxy_redirect off;
            proxy_intercept_errors on;

            proxy_connect_timeout 2s;
            proxy_send_timeout 5s;
            proxy_read_timeout 8s;
            proxy_buffering on;
            proxy_buffers 8 16k;
            proxy_buffer_size 32k;
            proxy_busy_buffers_size 64k;
            proxy_max_temp_file_size 0;

            proxy_set_header X-Max-Body-Bytes "16384";

            # preserve query string and forward to Flask
            proxy_pass http://public-app:8080/fetch$is_args$args;
        }

    }
}
